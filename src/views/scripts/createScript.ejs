<script>
  document.querySelector("form").addEventListener("submit", function (event) {
    event.preventDefault();

    var validationRules = {
      oname: {
        test: function (value) {
          return value !== "";
        },
        message: "Orchid Name is required",
      },
      oimage: {
        test: function (value) {
          return value !== "";
        },
        message: "Image File is required",
      },
      ocolor: {
        test: function (value) {
          return value !== "";
        },
        message: "Color is required",
      },
      oprice: {
        test: function (value) {
          return value !== "" && !isNaN(value) && value >= 0;
        },
        message: "Invalid Price",
      },
      isNatural: {
        test: function () {
          return (
            document.getElementById("isNaturalYes").checked ||
            document.getElementById("isNaturalNo").checked
          );
        },
        message: "Please select whether the orchid is natural or not",
      },
      ooriginal: {
        test: function (value) {
          return value !== "Open this select menu";
        },
        message: "Please select an Original name",
      },
    };

    var isValid = true;

    function showError(id, message) {
      var errorMessageElement = document.getElementById(id + "Error");
      if (message) {
        errorMessageElement.textContent = message;
        isValid = false;
      } else {
        errorMessageElement.textContent = "";
      }
    }

    for (var id in validationRules) {
      var value = id === "isNatural" ? null : document.getElementById(id).value;
      if (!validationRules[id].test(value)) {
        showError(id, validationRules[id].message);
      } else {
        showError(id, "");
      }
    }

    if (isValid) {
      uploadFile(event.target);
    }
  });

  function uploadFile(form) {
    var formData = new FormData(form);
    fetch("/upload", { method: "POST", body: formData })
      .then((response) => response.json())
      .then((result) => {
        if (result.fileURL) {
          document.querySelector("#hiddenFileURL").value = result.fileURL;
          formData.set("image", result.fileURL);
          submitForm(form, formData);
        }
      })
      .catch((error) => console.error("Error:", error));
  }

  function submitForm(form, formData) {
    var data = Object.fromEntries(formData);

    fetch("/orchids", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
    })
      .then((response) => {
        var toastEl;
        if (response.ok) {
          toastEl = document.querySelector("#successToast");
        } else {
          toastEl = document.querySelector("#errorToast");
        }
        var toast = new bootstrap.Toast(toastEl);
        toast.show();

        if (response.ok) {
          setTimeout(function () {
            window.location.href = "/orchids";
          }, 500);
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        var toastEl = document.querySelector("#errorToast");
        var toast = new bootstrap.Toast(toastEl);
        toast.show();
      });
  }
</script>
